@model Chat.Models.ChatRoomLabelViewModelList
@{
    ViewBag.Title = "ChatRoomsList";
    Layout = "~/Views/Shared/_ChatLayout.cshtml";
}

<h2>Chat rooms</h2>
<div>
    <span>New room:</span>
    <div class="form">
        <span class="error"></span>
        @Html.TextBox("roomName", "", new { required = "required" })
        <input type="button" value="Add" id="btnAdd" class="btn" />
    </div>

</div>
<div id="rooms">
    @Html.Partial("ChatRoomsLabelsList", Model)
</div>

@section scripts{
    <script src="~/Scripts/jquery.signalR-2.2.2.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>

    <script>
        $(function (e) {
            // Reference the auto-generated proxy for the hub.
            var rooms = $.connection.chatHub;
            // Create a function that the hub can call back to display messages.
            rooms.client.addNewMessageToPage = function (name, message) {
                $.ajax({
                    async: true,
                    method: "GET",
                    url: "/ChatRoom/GetChatRoomsLabelsList",
                }
                ).done(function (partialViewResult) {
                    $("#rooms").html(partialViewResult);
                    CheckVisitedStatus();
                });

            };
            // Start the connection.
            $.connection.hub.start().done(function () {
                $('#btnAdd').click(function (e) {
                    var roomName = $('#roomName').val();
                    $.ajax({
                        async: true,
                        method: "POST",
                        url: "/ChatRoom/NewRoom",
                        data: { roomName: roomName },
                        success: function (response) {
                            rooms.server.send(null, null);
                            $('#roomName').val('')
                            $(".error").html('');
                        },
                        error: function (response) {
                            e.preventDefault();
                            $(".error").html(response.responseText);
                        }
                    }
                    );
                });
            });
        });
    </script>

<script type="text/javascript">
        $(function () {
            CheckVisitedStatus();
        });
        function CheckVisitedStatus() {
            console.log("test");
            $("td.room-id").each(function () {
                console.log("pojedyncze");
                var element = $(this);
                console.log(element.html());
                var id = element.html();
                console.log(id);

                $.ajax({
                    async: false,
                    method: "GET",
                    url: "/ChatRoom/WasVisited",
                    data: { chatRoomId: id },
                    success: function (response) {
                        if (response == "False") {
                            element.parent().addClass("not-visited");
                            console.log(element.parent());
                            console.log("not visited")
                        } else {
                            element.parent().removeClass("not-visited");
                            console.log("visited");
                        }
                    },
                }
                );
            });
        }
</script>

}




